### 13. 동시성 🎑
> 동시성과 깔끔한 코드는 양립하기 어렵다.
> 깨끗한 동시성은 책 하나를 할당할 정도로 복잡한 주제이다.

## 동시성이 필요한 이유?
> 동시성은 결합을 없애는 전략이다.
- 무엇과 언제를 분리하면 애프리케이션 구조와 효율이 즉적으로 나아진다. 
- 예를 들어 서블릿은 웹, EJB 컨테이너 안에서 돌아가는데 컨테이너는 이를 동시성을 부분적으로 관리한다.
- 원칙적으로 각 서블릿 스레드는 다른 서브릿 스레드와 무관하게 자신만의 세상에서 돌아간다.

### 동시성 방어 원칙
- 단일 책임 원칙
  - 동시성은 복잡성 하나만으로도 따로 분리할 이유가 충분하다.
  - 동시성 코드는 독자적인 개발, 변경, 종류 주기가 있다.
  - 동시성 코드엔 독자적인 난관이 있다.
  - 다른 코드에서 겪는 난관과 다르며 훨씬 어렵다.
  - 잘못 구현한 동시성 코드는 별의별 방식으로 실패한다.
  - 주변에 있는다른 코드가 발목을 잡지 않더라도 동시성 하나만으로 충분히 어렵다.

- 따름 정의 : 자료 범위를 제한하라.
  - 보호할 임계영역을 빼먹는다.
  - 그래서 공유 자료를 수정하는 모든 코드를 망가뜨린다.
  - 모든 임계영역을 올바로 보호했는지 확인하느라 똑같은 노력과 수고를 반복한다.
  - 그렇지 않아도 찾아내기 어려운 버그가 더욱 찾기 어려워진다.

- 자료 사본을 사용해라
  - 공유 자료를 줄이려면 처음붙너 공유하지 않는 방법이 제일 좋다.
 
 ### 라이브러리를 이해하라
 - 스레드 환경에 안전한 컬랙션을 사용한다. 자바 5부터 제공한다.
 - 서로 무관한 작업을 수행할 때는 executor 프레임워크를 사용한다.
 - 가능하다면 스레드가 차단되지 않는 방법을 사용한다.
 - 일부 클래ㅅ 라이브러리는 스레드에 안전하지 못하다.

### 실행 모델을 이해하라.
> 다중 스레드 애프리케이션을 분류하는 방식은 어려가지이다.
- 한정된 자원
  - 다중 스레드 환경에서 사용하는 자원으로, 크기나 숫자가 제한적이다. 
  - 데이터베이스 연결, 길이가일정한 읽기/쓰기 버퍼 등이 예다.
- 상호 배제
  - 한 번에 한 스레드만 공유 자료나 공유 자원을 사용할 수 있는 경우를 가르킨다.
- 기아
  - 한 스레드나 여러 스레드가 굉장히 오랫동안 혹은 영원히 자원을 기다린다.
- 데드락
  - 여러 스레드가 서로 끝나기를 기다린다.
  - 모든 스레드가 각기 필요한 자원을 스레드가 점유하는 바람에 어느 쪽도 더 이상 진행하지 못한다.
- 라이브락
  - 락을 거는 단계에서 각 스레드가 서로를 방해한다.

### 동기화하는 부분을 작게 만들어라
> 영구적으로 돌아가는 시스템을 구현하는 방법과 잠시 돌다 깔끔하게 종료하느 시스템을 구현하는 방법은 다르다.
- 깔끔하게 종료하는 다중 스레드 코드를 짜야한다면 시간을 투자해 올바르게 구현하기 바란다.

### 스레드 코드 테스트하기
> 코드가 올바르다고 증명하기는 현실적으로 불가능하다.
- 말이 안 되는 실패는 잠정적인 스레드 문제로 취급하라
- 다중 스레드를 고려하지 않은 순차 코드부터 제대로 돌게 만들자
- 다중 스레드를 쓰는 코드 부분을 다양한 환경에 쉽게 끼어넣을 수 있도록 스레드 코드를 구현하라
- 프로세서 수보다 많은 스레드를 돌려보라.
- 다른 플랫폼에서 돌려보라
- 코드에 보조코드를 넣어 돌려라
- 강제로 실패를 이르키도록 해보라

### 결론
- 다중 스레드 코드는 올바로 구현하기 어렵다.
- 다중 스레드 코드를 작성한다면 각별히 깨긋하게 코드를 짜야 한다.
- 주의하지 않으면 희귀하고 오묘한 오류에 직면하게 된다.
- 스레드 코드는 출시하기 전까지 최대한 오랫동안 돌려봐야 한다.
- 깔끔한 접근 방식을 취한다면, 코드가 올바로 돌아갈 가능성이 극적으로 높아진다.

### 느낀점
- 스레드에 있어 더욱 깊게 알게되었다.
- 사용할 때 있어 더욱 신중하게, 출시 전까지 꼭 한번 더 체크해 확인해야 한다.
- 복잡한 부분이 많았지만 좀 더 지식이 많아진다면 이해하기 쉬울 것같다.
