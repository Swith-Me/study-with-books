# 13. 동시성🎑

### 동시성이 필요한 이유?

☑**동시성은 결합을 없애는 전략이다.**

- 무엇과 언제를 분리하는 전략이다.
- 동시성을 부분적으로 관리한다.

☑**미신과 오해에 대한 정답**

- 동시성은 다소 부하를 유발한다.
- 동시성은 복잡하다.
- 일반적으로 동시성 버그는 제현하기 어렵다.
- 동시성을 구현하려면 흔히 근본적인 설계 전략을 제고해야 한다.

### 난관

☑**동시성을 구현하기 어려운 이유**

- 일부 경로가 잘못된 결과를 내놓기 때문이다.

### 동시성 방어 원칙

☑**단일 책임 원칙** 

- 동시성 코드는 독자적인 개발, 변경, 조율 주기가 있다.
- 동시성 코드에는 독자적인 난관이 있다.
- 잘못 구현한 동시성 코드는 별의별 방식으로 실패한다.

🧨**권장사항 : 동시성 코드는 다른 코드와 분리하라**

☑**따름 정리** 

- 보호할 임계영역을 빼먹는다.
- 모든 임계영역을 올바로 보호했는지 확인하느라 똑같은 노력과 수고를 반복한다.
- 찾아내기 어려운 버그가 더욱 찾기 어려워진다.

### 라이브러리를 이해하라

- 스레드 환경에 안전한 컬렉션을 사용한다.
- 서로 무관한 작업을 수행할 때는 executor 프레임워크를 사용한다.
- 가능하다면 스레드가 차단 되지 않는 방법을 사용한다.
- 일부 클래스 라이브러리는 스레드에 안전하지 못하다.

### 실행 모델을 이해하라

☑**기본용어**

- 한정된 자원 : 다중 스레드 환경에서 사용하는 자원으로, 크기나 숫자가 제한적이다.
- 상호 배제 : 한 번에 한 스레드만 공유 자료나 공유 자원을 사용할 수 잇는 경우를 가리킨다.
- 기아 : 한 스레드나 여러 스레드가 굉장히 오랫동안 혹은 영원히 자원을 기다린다.
- 데드락 : 여러 스레드가 서로가 끝나기를 기다린다.
- 라이브락 : 락을 거는 단계에서 각 스레드가 서로를 방해한다.

### 동기화하는 메서드 사이에 존재하는 의존성을 이해하라.

☑**공유 객체 하나에는 메서드 하나만 사용하라.**

- 클라이언트에서 잠금 - 클라이언트에서 첫 번째 메서드를 호출하기 전에 서버를 잠근다. 마지막 메서드를 호출할 때까지 잠금을 유지한다.
- 서버에서 잠금 - 서버에다 "서버를 잠그고 모든 메서드를 호출한 후 잠금을 해제하는" 메서드를 구현한다
- 연결서버 - 잠금을 수행하는 중간 단계를 생성한다.

### 스레드 코드 테스트하기

☑**문제를 노출하는 테스트 케이스를 작성하라.**

- 말이 안 되는 실패는 잠정적인 스레드 문제로 취급하라.
- 다중 스레드를 고려하지 않은 순차 코드부터 제대로 돌게 만들자.
- 다중 스레드를 쓰는 코드 부분을 다양한 환경에 쉽게 끼워 넣을 수 있도록 스레드 코드를 구현하라.
- 다중 스레드를 쓰는 코드 부분을 상황에 맞춰 조정할 수 있게 작성하라.
- 프로세서 수보다 많은 스레드를 돌려보라.
- 다른 플랫폼에서 돌려보라.
- 코드에 보조 코드를 넣어 돌려라. 강제로 실패를 일으키게 해보라.

### 결론

☑**다중 스레드 코드는 올바로 구현하기 어렵다.**

- 스레드를 아는 코드와 스레드를 모르는 코드를 분리한다.
- 동시성 오류를 일으키는 잠정적인 원인을 철저히 이해한다.
- 사용하는 라이브러리와 기본 알고리즘을 이해한다.
- 공유하는 객체 수와 범위를 최대한 줄인다.
- 필요하다면 객체 설계를 변경해 클라이언트에게 편의를 제공한다.

### 기억에 남는 구절📖

> 어떻게든 문제는 생긴다.
