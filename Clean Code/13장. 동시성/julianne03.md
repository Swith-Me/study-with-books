## 13. 동시성

### 들어가면서

- 동시성과 깔끔한 코드는 양립하기 아주 어렵다.
- 깨끗한 동시성은 책 하나를 할당할 정도로 복잡한 주제이다.

**이 장에서...**

1. 여러 스레드를 동시에 돌리는 이유와 어려움
2. 이런 어려움을 대처하고 깨끗한 코드를 작성하는 방법
3. 동시성을 테스트하는 방법과 문제점

<br>

### 동시성이 필요한 이유

- 동시성은 무엇과 언제를 분리하는 전략이다.
- 무엇과 언제를 분리하면 애플리케이션 구조와 효율이 극적으로 나아진다.
- 프로그램이 거대한 루프 하나가 아니라 작은 협력 프로그램 여럿으로 보인다.
- 어떤 시스템은 응답 시간과 작업 처리량 개선이라는 요구사항으로 인해 직접적인 동시성 구현이 불가피하다.

<br>

### 동시성과 관련한 일반적인 미신과 오해

- 동시성은 항상 성능을 높여준다.

  - 대기 시간이 아주 길어 여러 스레드가 프로세서를 공유할 수 있거나
  - 여러 프로세서가 동시에 처리할 독립적인 계산이 충분히 많은 경우에만 성능을 높여준다.

- 동시성을 구현해도 설계는 변하지 않는다.

  - 일반적으로 무엇과 언제를 분리하면 시스템 구조가 크게 달라진다.

- 웹 또는 EJB 컨테이너를 사용하면 동시성을 이해할 필요가 없다.

  - 실제로는 컨테이너가 어떻게 동작하는지, 어떻게 동시 수정, 데드락 등과 같은 문제를 피할 수 있는지를 알아야만 한다.

<br>

### 동시성과 관련된 타당한 생각

- 동시성은 다소 부하를 유발한다.
- 동시성은 복잡하다.
- 일반적으로 동시성 버그는 재현하기 어렵다.
- 동시성을 구현하려면 흔히 근본적인 설계 전략을 재고해야 한다.

<br>

### 난관

- 두 스레드가 같은 변수를 동시에 참조하면 예상하지 못했던 결과가 발생한다.
- 이유는 두 스레드가 자바 코드 한 줄을 거쳐가는 경로는 수없이 많은데, 그 중에서 일부 경로가 잘못된 결과를 내놓기 때문이다.

<br>

### 동시성 방어 원칙

1. 단일 책임 원칙(SRP)

   - 동시성은 복잡성 하나만으로도 따로 분리할 이유가 충분하다.
   - 동시성 관련 코드는 다른 코드와 분리해야 한다.

2. 따름 정리: 자료 범위를 제한하라

   - 공유 객체를 사용하는 코드 내 임계영역을 `synchronized` 키워드로 보호하라고 권장한다.
   - 자료를 캡슐화하고 공유 자료를 최대한 줄여라.

3. 따름 정리: 자료 사본을 사용하라

   - 공유 자료를 줄이려면 처음부터 공유하지 않는 방법이 제일 좋다.
   - 어떤 경우에는 각 스레드가 객체를 복사해 사용한 후 한 스레드가 해당 사본에서 결과를 가져오는 방법도 가능하다.

4. 따름 정리: 스레드는 가능한 독립적으로 구현하라
   - 스레드는 다른 스레드와 자료를 공유하지 않게 구현하라.
   - 가능하면 다른 프로세서에서, 돌려도 괜찮도록 자료를 독립적인 단위로 분할하라.

<br>

### 라이브러리를 이해하라

- 언어가 제공하는 클래스를 검토하라.

<br>

### 실행 모델을 이해하라

**<기본 용어>**

- 한정된 자원: 다중 스레드 환경에서 사용하는 자원으로, 크기나 숫자가 제한적임.
- 상호 배제: 한 번에 한 스레드만 공유 자료나 공유 자원을 사용할 수 있는 경우
- 기아: 한 스레드나 여러 스레드가 굉장히 오랫동안 혹은 영원히 자원을 기다리는 상태
- 데드락: 여러 스레드가 서로가 끝나기를 기다린다. 어느 쪽도 더 이상 진행하지 못한다.
- 라이브락: 락을 거는 단계에서 각 스레드가 서로를 방해한다.

**<실행 모델>**

- 생산자-소비자
- 읽기-쓰기
- 식사하는 철학자들

<br>

### 동기화하는 메서드 사이에 존재하는 의존성을 이해하라

- 공유된 객체의 두 메서드 이상을 사용하는 것을 피하라.
- 만약 위 방법을 따를 수 없는 상황이라면 아래의 세 방법을 고려해 보라.

1. 클라이언트 기반 잠금
2. 서버 기반 잠금
3. 중계된 서버

<br>

### 동기화하는 부분을 작게 만들어라

- 자바에서 `synchronized` 키워드를 사용하면 락을 설정한다.
- 락은 스레드를 지연시키고 부하를 가중시킨다.
- 동기화하는 부분을 최대한 작게 만들어라.

<br>

### 올바른 종료 코드는 구현하기 어렵다

- 깔끔하게 종료하는 코드는 올바로 구현하기 어렵다.
- 가장 흔히 발생하는 문제가 데드락이다.
- 종료 코드를 개발 초기부터 고민하고 동작하게 초기부터 구현하라.
- 생각보다 어려우므로 이미 나온 알고리즘을 검토하자.

<br>

### 스레드 코드 테스트하기

- 태스트가 정확성을 보장하지는 않는다.
- 그럼에도 충분한 테스트는 위험을 낮춘다.
- 문제를 노출하는 테스트 케이스를 작성하라.
- 프로그램 설정과 시스템 설정과 부하를 바꿔가며 자주 돌려라.
- 실패한 테스트를 다시 돌렸더니 통과하더라는 이유로 그냥 넘어가면 절대로 안 된다.

**<지침>**

1. 말이 안 되는 실패는 잠정적인 스레드 문제로 취급하라.

   - 시스템 실패를 '일회성'이라 치부하지 마라.

2. 다중 스레드를 고려하지 않은 순차 코드부터 제대로 돌게 만들자.

   - 스레드 환경 밖에서 생기는 버그와 스레드 환경에서 생기는 버그를 동시에 디버깅하지 마라.
   - 먼저 스레드 환경 밖에서 코드를 올바로 돌려라.

3. 다중 스레드를 쓰는 코드 부분을 다양한 환경에 쉽게 끼워 넣을 수 있게 스레드 코드를 구현하라.

   - 다양한 설정에서 실행할 목적으로 코드를 구현하라.

4. 다중 스레드를 쓰는 코드 부분을 상황에 맞춰 조정할 수 있게 작성하라.

5. 프로세서 수보다 많은 스레드를 돌려보라.

6. 다른 플랫폼에서 돌려보라.

   - 처음부터 그리고 자주 모든 목표 플랫폼에서 코드를 돌려라.

7. 코드에 보조 코드를 넣어 돌려라. 강제로 실패를 일으키게 해보라.

   - 코드에 보조 코드를 추가하는 방법 두 가지
     1. 직접 구현하기
     2. 자동화

<br>

### 결론

- 다중 스레드 코드는 올바로 구현하기 어렵다.
- 무엇보다 먼저, SRP를 준수한다.
- 동시성 오류를 일으키는 잠정적인 원인을 철저히 이해한다.
- 사용하는 라이브러리와 기본 알고리즘을 이해한다.
- 초반에 드러나지 않는 문제는 일회성으로 치부해 무시하기 십상이다.
- 초반부터 보조 코드를 고려한다.
- 스레드 코드는 출시하기 전까지 최대한 오랫동안 돌려봐야 한다.

<br>

### 느낀점

- 학교에서 자바를 배울 때 다중 스레드에 대해서 배우기는 했지만 정말 얕게 배웠었다는 것을 깨달았다.
- 처음 이 장을 시작할 때 책에서 나왔다시피 깨끗한 동시성을 정확히 알기 위해선 이것보다 훨씬 자세히 파고들어야 한다고 느꼈다.
