# 11. 클라이언트 식별과 쿠키

## 11.0 Intro

- 웹 서버는 서로 다른 수천 개의 클라이언트들과 동시에 통신한다.
- 이 장에서는 서버가 통신하는 대상을 식별하는 데 사용하는 기술을 알아본다.

<br>

## 11.1 개별 접촉

- 웹 서버는 요청을 보낸 사용자를 식별하거나 방문자가 보낸 연속적인 요청을 추적하기 위해 약간의 정보를 이용할 수 있다.
- 현대의 웹 사이트들은 개인화된 서비스를 제공하고 싶어 한다.
- 종류로는 개별인사, 사용자 맞춤 추천, 저장된 사용자 정보, 세션 추적 등이 있다.

<br>

## 11.2 HTTP 헤더

**From 헤더**

- 사용자의 이메일 주소를 포함한다.
- 이상적으로 각 사용자는 서로 다른 이메일 주소를 가지므로 사용자를 식별할 순 있다.
- 하지만 악의적인 문제로 인해 From 헤더를 보내는 브라우저는 흔치 않다.

<br>

**User-Agent 헤더**

- 사용자가 쓰고 있는 브라우저의 이름과 버전 정보, 어떤 경우에는 운영체제에 대한 정보까지 포함하여 서버에게 알려준다.
- 특정 사용자를 식별하는 데는 큰 도움이 되지 않는다.

<br>

**Referer 헤더**

- 사용자가 현재 페이지로 유입하게 한 웹페이지의 URL을 가리킨다.
- 자체만으로 사용자를 식별할 수는 없지만, 사용자가 이전에 어떤 페이지를 방문했었는지는 알려준다.

<br>

## 11.3 클라이언트 IP 주소

- 초기 웹 선구자들은 사용자 식별에 클라이언트 IP 주소를 사용하려 했다.
- 안타깝게도 클라이언트 IP 주소로 사용자를 식별하는 방식은 다음과 같은 약점을 가진다.
    - 만약 여러 사용자가 같은 컴퓨터를 사용한다면 그들을 식별할 수 없다.
    - 로그인한 시간에 따라, 사용자는 매번 다른 주소를 받으므로, 웹 서버는 사용자를 IP 주소로 식별할 수 없다.
    - 방화벽 뒤로 실제 IP 주소를 숨길 수도 있다.
    - 웹 서버는 클라이언트의 IP 주소 대신 프락시 서버의 IP 주소를 본다.

아직도 세션 간에 사용자를 추적하려고 클라이언트 IP 주소를 사용하는 웹사이트가 있지만 이 방식은 제대로 동작하지 않기 때문에 사용하지 않는다.

<br>

## 11.4 사용자 로그인

- 웹 서버는 사용자 이름과 비밀번호로 인증할 것을 요구해서 사용자에게 명시적으로 식별 요청을 할 수 있다.
- 서버에서, 사용자가 사이트에 접근하기 전에 로그인을 시키고자 한다면 HTTP 401 Login Required 응답 코드를 브라우저에 보낼 수 있다.

<br>

## 11.5 뚱뚱한 URL

- 어떤 웹 사이트는 사용자의 URL마다 버전을 기술하여 사용자를 식별하고 추적하였다.
- 보통, URL은 URL 경로의 처음이나 끝에 어떤 상태 정보를 추가해 확장한다.
- 사용자의 상태 정보를 포함하고 있는 URL을 뚱뚱한 URL이라고 한다.
- 뚱뚱한 URL은 사이트를 브라우징하는 사용자를 식별하는 데 사용할 수 있다.

**뚱뚱한 URL의 문제점**

- 브라우저에 보이는 뚱뚱한 URL은 새로운 사용자들에게 혼란을 준다.
- 뚱뚱한 URL은 특정 사용자와 세션에 대한 상태 정보를 포함하는데 누군가에게 메일을 보내면 개인 정보를 공유하게 되버린다.
- 기존 캐시에 접근할 수 없다.
- HTML 페이지를 다시 그려야 하기 때문에 서버에 부하가 일어난다.
- 사용자가 링크를 타고 다른 사이트로 이동하거나 특정 URL을 요청해서 의도치 않게 뚱뚱한 URL 세션에서 '이탈'하기 쉽다.
- 사용자가 특정 뚱뚱한 URL을 북마킹하지 않는 이상, 로그아웃하면 모든 정보를 잃는다.

<br>

## 11.6 쿠키

- 쿠키는 사용자를 식별하고 세션을 유지하는 방식 중에서 현재까지 가장 널리 사용하는 방식이다.
- 쿠키는 매우 중요한 웹 기술일 뿐만 아니라 새로운 HTTP 헤더를 정의한다.

<br>

### 11.6.1 쿠키의 타입

- 쿠키는 크게 세션 쿠키와 지속 쿠키 두 가지 타입으로 나눌 수 있다.
- 세션 쿠키는 사용자가 사이트를 탐색할 때, 관련한 설정과 선호 사항들을 저장하는 임시 쿠키다.
- 세션 쿠키는 사용자가 브라우저를 닫으면 삭제된다.
- 지속 쿠키는 삭제되지 않고 브라우저를 닫거나 컴퓨터를 재시작하더라도 남아있다.
- 세션 쿠키와 지속 쿠키의 다른 점은 파기되는 시점이다.

<br>

### 11.6.2 쿠키는 어떻게 동작하는가

- 쿠키는 서버가 사용자에게 "안녕 내 이름은.." 라고 적어서 붙이는 스티커와 같다.
- 처음에 사용자가 웹 사이트에 방문하면 웹 서버는 사용자에 대해서 아무것도 모른다.
- 웹 서버는 사용자가 다시 돌아왔을 때, 해당 사용자를 식별하기 위한 유일한 값을 쿠키에 할당한다.

<br>

### 11.6.43 쿠키 상자: 클라이언트 측 상태

- 쿠키의 기본적인 발상은 브라우저가 서버 관련 정보를 저장하고, 사용자가 해당 서버에 접근할 때마다 그 정보를 함께 전송하게 하는 것이다.

<br>

### 11.6.4 사이트마다 각기 다른 쿠키들

- 브라우저는 사실 보통 각 사이트에 두 개 혹은 세 개의 쿠키만을 보낸다.
- 쿠키를 모두 전달하면 성능이 크게 저하된다.

**쿠키 Domain 속성**

- 서버는 쿠키를 생성할 때 `Set-Cookie` 응답 헤더에 Domain 속성을 기술해서 어떤 사이트가 그 쿠키를 읽을 수 있는지 제어할 수 있다.

<br>

**쿠키 Path 속성**

- 웹 사이트 일부에만 쿠키를 적용할 수도 있다.
- URL 경로의 앞부분을 가리키는 Path 속성을 기술해서 해당 경로에 속하는 페이지에만 쿠키를 전달한다.

<br>

### 11.6.5 쿠키 구성요소

- 현재 사용되는 쿠키 명세에는 Version 0 쿠키와 Version 1 쿠키가 있다.
- Version 1 쿠키는 Version 0 쿠키의 확장으로 널리 쓰이지는 않는다.

<br>

### 11.6.8 쿠키와 세션 추적

- 쿠키는 웹 사이트에 수차례 트랜잭션을 만들어내는 사용자를 추적하는 데 사용한다.

<br>

### 11.6.9 쿠키와 캐싱

- 쿠키 트랜잭션과 관련된 문서를 캐싱하는 것은 주의해야 한다.
- 이전 사용자의 쿠키가 다른 사용자에게 할당돼버리거나, 누군가의 개인 정보가 다른 이에게 노출되는 상황이 일어날 수도 있다.

<br>

**<캐시를 다루는 기본 원칙>**

1. 캐시되지 말아야 할 문서가 있다면 표시하라
2. Set-Cookie 헤더를 캐시 하는 것에 유의하라
3. Cookie 헤더를 가지고 있는 요청을 주의하라

<br>

### 11.6.10 쿠키, 보안 그리고 개인정보

- 쿠키를 사용하지 않도록 비활성화시킬 수 있고, 로그 분석 같은 다른 방법으로 대체하는 것도 가능하므로, 그 자체가 보안상으로 엄청나게 위험한 것은 아니다.
- 개인정보를 다루거나 사용자를 추적하는 기술은 잘못된 의도로 사용될 수 있기 때문에 항상 조심하는 것이 좋다.