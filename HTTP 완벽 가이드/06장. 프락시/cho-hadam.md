# [06장] 프락시

프락시는 클라이언트와 서버 사이에 위치하여 그들 사이의 HTTP 메시지를 정리하는 중개인처럼 동작한다.

<br />

## 웹 중개자

HTTP 프락시 서버는 웹 서버이기도 하고 웹 클라이언트이기도 하다.

### 개인 프락시와 공유 프락시

**개인 프락시**  
하나의 클라이언트만을 위한 프락시

**공용 프락시**  
여러 클라이언트가 함께 사용하는 프락시  
대부분의 프락시이다

### 프락시 vs 게이트웨이

프락시는 같은 프로토콜을 사용하는 둘 이상의 애플리케이션을 연결하고,  
게이트웨이는 서로 다른 프로토콜을 사용하는 둘 이상을 연결한다.

<br />

## 왜 프락시를 사용하는가?

프락시 서버는 보안을 개선하고, 성능을 높여주며, 비용을 절약한다.

- 어린이 필터
- 문서 접근 제어자
- 보안 방화벽
- 웹 캐시
- 대리 프락시
- 콘텐츠 라우터
- 트랜스코더
- 익명화 프락시

<br />

## 프락시는 어디에 있는가

### 프락시 서버 배치

어떻게 사용할지에 따라서 프락시는 어디에든 배치할 수 있다.

- 출구 프락시
- 접근(입구) 프락시
- 대리 프락시
- 네트워크 교환 프락시

### 프락시 계층

접근 프락시는 상황에 맞게 부모 프락시나 원 서버에게 라우팅한다.

동적 부모 선택의 몇 가지 예

- 부하 균형
- 지리적 인접성에 근거한 라우팅
- 프로토콜/타입 라우팅

### 어떻게 프락시가 트래픽을 처리하는가

클라이언트 트래픽이 프락시로 가도록 만드는 방법

- 클라이언트를 수정한다
- 네트워크를 수정한다
- DNS 이름공간을 수정한다
- 웹 서버를 수정한다

<br />

## 클라이언트 프락시 설정

### 수동

프락시의 호스트와 포트를 지정한다.

### PAC 파일

프락시 자동 설정`PAC` 파일은 프락시 설정을 그때그때 상황에 맞게 계산해주는 작은 자바스크립트 프로그램이다.

각 PAC 파일은 반드시 URI에 접근할 때 사용할 적절한 프락시 서버를 계산해주는 `FindProxyForUrl(url, host)`라는 함수를 정의해야 한다.

| FindProxyForURL 반환값 | 설명                                     |
| ---------------------- | ---------------------------------------- |
| DIRECT                 | 프락시 없이 연결이 직접 이루어져야 한다. |
| PROXY host:port        | 지정한 프락시를 사용해야 한다.           |
| SOCKS host:port        | 지정한 SOCKS 서버를 사용해야 한다.       |

### WPAD

WPAD는 여러 발견 메커니즘들의 상승 전략을 이용해 브라우저에게 알맞은 PAC 파일을 자동으로 찾아주는 알고리즘이다.

<br />

## 프락시 요청의 미묘한 특징들

### 프락시 URI는 서버 URI와 다르다

웹 서버로 요청을 보낼 때, 요청줄은 부분 URI를 가진다

> /index.html

프락시로 요청을 보낼 때, 요청줄은 완전한 URI를 갖는다

> http://www.marys-antiques.com/index.html

### 프락시는 프락시 요청과 서버 요청을 모두 다룰 수 있다

다목적 프락시 서버는 요청 메시지의 완전한 URI와 부분 URI를 모두 지원해야 한다.

### 전송 중 URI 변경

무해해 보이는 사소한 URI 변경이라도 다운스트림 서버와 상호운용성 문제를 일으킬 수 있다.

### URI 클라이언트 자동확장과 호스트 명 분석`Hostname Resolution`

프락시가 없다면 사용자가 타이핑한 URI를 가지고 그에 대응하는 IP 주소를 찾는다.  
만약 호스트명이 발견되면 그에 대응하는 IP 주소들을 연결에 성공할 때까지 시도해본다.  
그러나 호스트가 발견되지 않는다면, `확장`을 제공한다.

### 명시적인 프락시를 사용할 때의 URI 분석

명시적인 프락시를 사용한다면, 브라우저는 이와 같이 편리한 확장들 중 어느 것도 더 이상 수행할 수 없다.

<br />

## 메시지 추적

웹 요펑이 클라이언트에서 서버로 향하는 도중에 둘 이상의 프락시를 지나게 되는 것은 드문 일이 아니다.

프락시가 점점 더 흔해지면서, 프락시를 넘나드는 메시지의 흐름을 추적하고 문제점을 찾아내는 것도 필요한 일이 되었다.

### Via 헤더

Via 헤더 필드는 메시지가 지나는 각 중간 노드(프락시나 게이트웨이)의 정보를 나열한다.

### Server 헤더

Server 응답 헤더 필드는 원 서버에 의해 사용되는 소프트웨어를 알려준다.  
프락시는 Server 헤더를 수정해서는 안 된다.

### TRACE 메서드

TRACE 메서드는 요청 메시지를 프락시의 연쇄를 따라가면서 어떤 프락시를 지나가고 어떻게 각 프락시가 요청 메시지를 수정하는지 관찰/추적할 수 있도록 해준다.

### Max-Forwards

Max-Forward 요청 헤더 필드는 이 요청 메시지가 몇 번 더 다음 홉으로 전달될 수 있는지 말해주는 정수 하나를 담고 있다.

<br />

## 프락시 인증

<br />

## 프락시 상호운용성

### 지원하지 않는 헤더와 메서드 다루기

프락시는 이해할 수 없는 헤더 필드는 반드시 그대로 전달해야 하며,  
같은 이름의 헤더 필드가 여러 개 있는 경우에는 그들의 상대적인 순서도 반드시 유지해야 한다.  
어떤 메서드와 친숙하지 않다면, 가능한 한 그 메시지를 다음 홉으로 전달하려 시도해야 한다.

### OPTIONS: 어떤 기능을 지원하는지 알아보기

OPTIONS 메서드는 서버나 웹 서버의 특정 리소스가 어떤 기능을 지원하는지 클라이언트(혹은 프락시)가 알아볼 수 있게 해준다.

### Allow 헤더

Allow 엔터티 헤더 필드는, 요청 URI에 의해 식별되는 자원에 대해 지원되는 메서드들이나 서버가 지원하는 모든 메서드(요청 URI가 \*인 경우)를 열거한다.

> Allow: GET, HEAD, PUT
